@page "/"
@using BaWebtool2.Data
@using Blazored.SessionStorage
@using Microsoft.EntityFrameworkCore
@inject ISessionStorageService SessionStorage
@inject ApplicationDbContext DbContext

<!-- Such-Funktion -->
<input type="text"
       value="@searchTerm"
       @oninput="OnSearchChanged"
       placeholder="Search for title or author..."
       class="p-2 border rounded mb-4 w-full" />



<!-- Kategorieauswahl -->
<select @bind="_selectedAlgorithmCategory" @bind:after="OnCategoryChanged" class="form-select mb-3">
    @foreach (var category in Enum.GetValues<Algorithm.AlgorithmCategory>())
    {
        <option value="@category">@category.GetDisplayName()</option>
    }
</select>

<!-- Jahrauswahl mit Dropdowns -->
<div class="mb-4">
    <label class="form-label">Select year range:</label>
    <div class="d-flex align-items-center gap-3">
        <select class="form-select" @bind="yearFrom" @bind:after="ApplyFilter">
            @foreach (var year in Enumerable.Range(2000, 26))
            {
                <option value="@year">@year</option>
            }
        </select>
        <span>bis</span>
        <select class="form-select" @bind="yearTo" @bind:after="ApplyFilter">
        @foreach (var year in Enumerable.Range(2000, 26))
            {
                <option value="@year">@year</option>
            }
        </select>
    </div>
    <div class="mt-1 text-muted small">Period: @yearFrom – @yearTo</div>
</div>



<!-- Datenpunkt-Filter (ausklappbar) -->
<div class="mb-4">
    <strong @onclick="ToggleFilter" style="cursor: pointer;">
        <span>@(showDataPointFilter ? "▼" : "▶")</span>
        Select your existing data:
    </strong>

    @if (showDataPointFilter)
    {
        <div class="flex gap-3 my-2">
            <button style="background-color: #4b5563; color: white;" class="px-3 py-1 rounded hover:brightness-110"
                    @onclick="SelectAllDataPoints">Select all</button>
            <button style="background-color: #4b5563; color: white;" class="px-3 py-1 rounded hover:brightness-110"
                    @onclick="DeselectAllDataPoints">Deselect all</button>
            <button style="background-color: #00008B; border-color: #00008B; color: white" class="px-3 py-1 rounded hover:brightness-110"
                    @onclick="OpenMissingDataModal">Show Algorithms with Missing Data Points</button>
        </div>

        @if (allDataPoints is not null)
        {
            var groupedDataPoints = allDataPoints
            .GroupBy(dp => dp.Category)
            .OrderBy(g => g.Key);

            <div class="row">
                @foreach (var group in groupedDataPoints)
                {
                    <div class="col-md-6 col-lg-4 mb-4">
                        <h6 class="fw-bold">@group.Key</h6>
                        @foreach (var dp in group)
                        {
                        <div class="form-check">
                            <input type="checkbox"
                                   id="@dp.DataPointId"
                                   class="form-check-input"
                                   @bind="selectedDataPointIds[dp.DataPointId]" 
                                   @bind:after="ApplyFilter"/>
                            <label class="form-check-label" for="@dp.DataPointId">@dp.DataPointName</label>
                        </div>
                        }
                    </div>
                }
            </div>
        }
    }
</div> 


<!-- Algorithmen anzeigen -->
<AlgorithmGrid Algorithms="selectedAlgorithms" />

<!-- Showing algorithms with missing data points-->
@if (showMissingModal)
{
<div class="modal-backdrop fade show"></div>
<div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0, 0, 0, 0.5);">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content shadow-lg rounded-4">
            <div class="modal-header" style="background-color: #483D8B; color: white;">
                <h5 class="modal-title">Algorithms with missing Data Points</h5>
                <button type="button" class="btn-close btn-close-white" @onclick="CloseMissingModal"></button>
            </div>
            <div class="modal-body">
                @if (algorithmsWithMissingData.Any())
                {
                <div class="mb-4">
                    @foreach (var alg in algorithmsWithMissingData)
                    {
                    <div class="card mb-2 shadow-sm">
                        <div class="card-body">
                            <div class="fw-semibold mb-2">
                                @alg.AlgorithmName
                            </div>
                            <div class="d-flex justify-content-end">
                                <button class="btn btn-sm btn-outline-danger"
                                        style="min-width: 120px;"
                                        @onclick="() => ShowMissingDataPointsFor(alg)">
                                    Show Missing
                                </button>
                            </div>
                        </div>
                    </div>
                    }
                </div>
                }
                else
                {
                <div class="alert alert-success">
                    No algorithms have missing data points based on your current selection.
                </div>
                }

                @if (selectedMissingDataPoints.Any())
                {
                <div class="background-datapoint">
                    <strong>Missing Data Points:</strong>
                    <ul class="mb-0">
                        @foreach (var dp in selectedMissingDataPoints)
                        {
                        <li>@dp.DataPointName</li>
                        }
                    </ul>
                </div>
                }
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="CloseMissingModal">Close</button>
            </div>
        </div>
    </div>
</div>


}


<NavLink class="btn btn-primary" href="/createAlgorithm">Creating new algorithm</NavLink>

@code {
    private string _searchTerm = "";

    private string searchTerm = string.Empty;

    private Algorithm.AlgorithmCategory _selectedAlgorithmCategory = Algorithm.AlgorithmCategory.AllCategories;

    private List<DataPoint> allDataPoints = new();
    private Dictionary<Guid, bool> selectedDataPointIds = new(); // Guid -> IsSelected

    private bool showDataPointFilter = false;

    private int yearFrom = 2000;
    private int yearTo = 2025;

    private List<Algorithm> allAlgorithms = new();
    private List<Algorithm> selectedAlgorithms = new();

    private bool showMissingModal = false;
    private List<Algorithm> algorithmsWithMissingData = new();
    private List<DataPoint> selectedMissingDataPoints = new();
    


    protected override async Task OnInitializedAsync()
    {
        allDataPoints = await DbContext.DataPoints.ToListAsync();

        foreach (var dp in allDataPoints)
        {
            selectedDataPointIds[dp.DataPointId] = true;
        }

        allAlgorithms = await DbContext.Algorithms
            .Include(al => al.DataPoints)
            .ToListAsync();

        await ApplyFilter(); // initiale Filterung
    }

    private async Task OnCategoryChanged()
    {
        await SessionStorage.SetItemAsync("selectedCategory", _selectedAlgorithmCategory.ToString());
        await ApplyFilter();
    }

    private async Task FilterAlgorithms(ChangeEventArgs e)
    {
        searchTerm = e?.Value?.ToString() ?? string.Empty;
        await ApplyFilter();
    }

    private async Task ApplyFilter()
    {
        IEnumerable<Algorithm> filtered = allAlgorithms;

        if (_selectedAlgorithmCategory != Algorithm.AlgorithmCategory.AllCategories)
        {
            filtered = filtered.Where(al => al.Category == _selectedAlgorithmCategory);
        }


        if (selectedDataPointIds != null && selectedDataPointIds.Values.Any(v => v))
        {
            var selectedIds = selectedDataPointIds.Where(kv => kv.Value).Select(kv => kv.Key).ToList();
            filtered = filtered.Where(al =>
                al.DataPoints.All(dp => selectedIds.Contains(dp.DataPointId)));
        }

        filtered = filtered.Where(al => al.Year >= yearFrom && al.Year <= yearTo);


        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            filtered = filtered.Where(al =>
                (!string.IsNullOrEmpty(al.AlgorithmName) && al.AlgorithmName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)) ||
                (!string.IsNullOrEmpty(al.Author) && al.Author.Contains(searchTerm, StringComparison.OrdinalIgnoreCase)));
        }

        selectedAlgorithms = filtered.ToList();
        StateHasChanged();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var storedCategory = await SessionStorage.GetItemAsync<string>("selectedCategory");

            if (!string.IsNullOrEmpty(storedCategory) && Enum.TryParse(storedCategory, out Algorithm.AlgorithmCategory parsedCategory))
            {
                _selectedAlgorithmCategory = parsedCategory;
                await ApplyFilter();
                StateHasChanged(); // UI nach dem Laden der Daten aktualisieren
            }
        }
    }

    private async Task SelectAllDataPoints()
    {
        foreach (var key in selectedDataPointIds.Keys.ToList())
        {
            selectedDataPointIds[key] = true;
        }

        await ApplyFilter();
    }

    private async Task DeselectAllDataPoints()
    {
        foreach (var key in selectedDataPointIds.Keys.ToList())
        {
            selectedDataPointIds[key] = false;
        }

        await ApplyFilter();
    }

    private void ToggleFilter()
    {
        showDataPointFilter = !showDataPointFilter;
    }

    private void OpenMissingDataModal()
    {
        var selectedData = selectedDataPointIds
            .Where(kv => kv.Value)
            .Select(kv => kv.Key)
            .ToHashSet();

        algorithmsWithMissingData = allAlgorithms
            .Where(alg => alg.DataPoints.Any(dp => !selectedData.Contains(dp.DataPointId)))
            .ToList();

        selectedMissingDataPoints.Clear();
        showMissingModal = true;
    }

    private void CloseMissingModal()
    {
        showMissingModal = false;
        selectedMissingDataPoints.Clear();
    }

    private void ShowMissingDataPointsFor(Algorithm algorithm)
    {
        var selectedData = selectedDataPointIds
            .Where(kv => kv.Value)
            .Select(kv => kv.Key)
            .ToHashSet();

        selectedMissingDataPoints = algorithm.DataPoints
            .Where(dp => !selectedData.Contains(dp.DataPointId))
            .ToList();
    }
    

    
    private async Task OnSearchChanged(ChangeEventArgs e)
    {
        searchTerm = e?.Value?.ToString() ?? string.Empty;
        await ApplyFilter();
    }
   
}
