@page "/createDataPoint"
@using BaWebtool2.Data
@inject ApplicationDbContext DbContext
@inject NavigationManager Nav

<h3>Create DataPoint</h3>

<EditForm Model="@DataPoint" OnValidSubmit="HandleValidSubmit">
    <DataAnnotationsValidator />

    <!-- DataPoint Name -->
    <div class="form-group mb-4">
        <label>Datapoint Name *</label>
        <InputText class="@($"form-control {(HasError(nameof(DataPoint.DataPointName)) ? "is-invalid" : "")}")"
                   @bind-Value="DataPoint.DataPointName" />
        <ValidationMessage For="@(() => DataPoint.DataPointName)" />
    </div>

    <!-- Description (optional) -->
    <div class="form-group mb-4">
        <label>Description</label>
        <InputTextArea class="form-control"
                       @bind-Value="DataPoint.DataPointDescription"
                       rows="3" />
    </div>

    <!-- Atomic Attribute -->
    <div class="form-group form-check mb-4">
        <InputCheckbox class="@($"form-check-input {(HasError(nameof(DataPoint.AtomicAttribute)) ? "is-invalid" : "")}")"
                       @bind-Value="DataPoint.AtomicAttribute" />
        <label class="form-check-label">Atomic Attribute *</label>
        <ValidationMessage For="@(() => DataPoint.AtomicAttribute)" />
    </div>

    <!-- ValueSet (optional)-->
    <div class="form-group mb-4">
        <label>Values (commaâ€‘seperated)</label>
        <InputText class="form-control"
                   @bind-Value="ValueSetInput" />
        <small class="form-text text-muted">
            E.g. "Value1,Value2,Value3"
        </small>
    </div>

    <!-- Category Dropdown -->
    <div class="form-group mb-4">
        <label for="categorySelect">Category *</label>
        <InputSelect class="@($"form-control {(HasError(nameof(DataPoint.Category)) ? "is-invalid" : "")}")"
                     id="categorySelect"
                     @bind-Value="DataPoint.Category">
            <option disabled value="">-- select --</option>
            @foreach (var category in Enum.GetValues<DataPoint.DataPointCategory>())
            {
            <option value="@category">@category.GetDisplayName()</option>
            }
        </InputSelect>
        <ValidationMessage For="@(() => DataPoint.Category)" />
    </div>

    <!-- Patientype (optional) -->
    <div class="form-group mb-4">
        <label>Type of patient</label>
        <InputSelect class="form-control"
                     @bind-Value="DataPoint.PatientType">
            <option value="">-- select --</option>
            <option value="Mother">Mother</option>
            <option value="Child">Child</option>
        </InputSelect>
    </div>

    <div class="mt-4">
        <button type="submit" class="btn btn-primary px-4">Submit</button>
    </div>
</EditForm>

@code {
    private DataPoint DataPoint { get; set; } = new();
    private string ValueSetInput { get; set; } = "";
    private EditContext? EditContext;

    private async Task HandleValidSubmit()
    {
        if (!string.IsNullOrWhiteSpace(ValueSetInput))
        {
            DataPoint.ValueSet = ValueSetInput
                .Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries)
                .ToList();
        }

        if (DataPoint.DataPointId == Guid.Empty)
            DataPoint.DataPointId = Guid.NewGuid();

        DbContext.DataPoints.Add(DataPoint);
        await DbContext.SaveChangesAsync();

        Console.WriteLine("DataPoint valid and ready to save!");
        Nav.NavigateTo("/datapoints");
    }
    
    private bool HasError(string fieldName) =>
        EditContext?.GetValidationMessages(new FieldIdentifier(DataPoint, fieldName)).Any() ?? false;

    protected override void OnInitialized()
    {
        DataPoint.Category = null;
        EditContext = new EditContext(DataPoint);
    }
}