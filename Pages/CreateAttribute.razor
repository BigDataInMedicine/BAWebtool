@page "/createAttribute"
@using BaWebtool2.Data
@using Attribute = BaWebtool2.Data.Attribute
@inject ApplicationDbContext DbContext
@inject NavigationManager Nav

<h3>Create Attribute</h3>

<EditForm Model="@Attribute" OnValidSubmit="HandleValidSubmit">
    <DataAnnotationsValidator />

    <!-- Attribute Name -->
    <div class="form-group mb-4">
        <label>Attribute Name *</label>
        <InputText class="@($"form-control {(HasError(nameof(Attribute.AttributeName)) ? "is-invalid" : "")}")"
                   @bind-Value="Attribute.AttributeName" />
        <ValidationMessage For="@(() => Attribute.AttributeName)" />
    </div>

    <!-- AttributeType (optional) -->
    <div class="form-group mb-4">
        <label>Type of attribute</label>
        <InputSelect class="form-control"
                     @bind-Value="Attribute.AttributeType">
            <option value="">-- select --</option>
            <option value="Atomic attribute">Atomic</option>
            <option value="Derived attribute">Derived</option>
            <option value="Multi-value attribute">Multi-value</option>
            <option value="Key attribute">Key</option>
        </InputSelect>
    </div>

    <!-- Description (optional) -->
    <div class="form-group mb-4">
        <label>Description</label>
        <InputTextArea class="form-control"
                       @bind-Value="Attribute.AttributeDescription"
                       rows="3" />
    </div>

    <!-- DataType -->
    <div class="form-group mb-4">
        <label>Datatype *</label>
        <InputSelect class="@($"form-control {(HasError(nameof(Attribute.DataType)) ? "is-invalid" : "")}")"
                     @bind-Value="Attribute.DataType" >
            <option value="">-- select --</option>
            <option value="Boolean">Boolean</option>
            <option value="String">String</option>
            <option value="Timestamp">Timestamp</option>
            <option value="Integer">Integer</option>
            <option value="Double/float">Floating point number</option>
            <option value="Image">Image</option>
        </InputSelect>
    </div>

    <!-- ValueSet (optional)-->
    <div class="form-group mb-4">
        <label>Values (commaâ€‘seperated)</label>
        <InputText class="form-control"
                   @bind-Value="ValueSetInput" />
        <small class="form-text text-muted">
            E.g. "Value1,Value2,Value3"
        </small>
    </div>

</EditForm>

@code {
    private Attribute Attribute { get; set; } = new();
    private EditContext? EditContext;
    private string ValueSetInput { get; set; } = "";

    protected override void OnInitialized()
    {
        EditContext = new EditContext(Attribute);
    }

    private async Task HandleValidSubmit()
    {
        if (!string.IsNullOrWhiteSpace(ValueSetInput))
        {
            Attribute.ValueSet = ValueSetInput
                .Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries)
                .ToList();
        }

        if (Attribute.AttributeId == Guid.Empty)
            Attribute.AttributeId = Guid.NewGuid();

        DbContext.Attributes.Add(Attribute);
        await DbContext.SaveChangesAsync();

        Console.WriteLine("Attribute valid and ready to save!");
        Nav.NavigateTo("/");
    }
    
    private bool HasError(string fieldName) =>
        EditContext?.GetValidationMessages(new FieldIdentifier(Attribute, fieldName)).Any() ?? false;

}